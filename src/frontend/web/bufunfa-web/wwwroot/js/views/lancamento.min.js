var Lancamento=function(){var f=function(){$("#tblLancamento").DataTable({ajax:{url:App.corrigirPathRota("/lancamentos/listar-lancamentos"),type:"POST",error:function(n){let t=Feedback.converter(n.responseJSON);t.exibir()},data:function(n){n.IdConta=$("#iIdConta").val();n.IdCategoria=$("#sProcurarCategoria").val();n.IdPessoa=$("#sProcurarPessoa").val();n.Valor=$("#iProcurarDataInicio").val();n.DataInicio=$("#iProcurarDataInicio").val();n.DataFim=$("#iProcurarDataFim").val()}},info:!0,columns:[{data:"data",title:"Data",orderable:!0,className:"all text-nowrap kt-padding-l-15 kt-padding-r-15",render:function(n){return moment(n).format("DD/MM/YYYY")+' <span class="kt-badge kt-badge--dark kt-badge--dot kt-badge--sm"><\/span> <small class="kt-font-bolder kt-font-primary">'+moment(n).format("ddd").toUpperCase()+"<\/small>"}},{data:"categoria",title:"Categoria",orderable:!0,className:"all text-nowrap",render:function(n,t,i){return'<i class="fa fa-tag kt-font-'+(i.tipoCategoria=="C"?"success":"danger")+' kt-font-sm"><\/i>  '+n}},{data:"pessoa",title:"Pessoa",orderable:!0,className:"all text-nowrap"},{data:"observacao",title:"Observação",orderable:!1,className:"all text-nowrap"},{data:"valor",title:"Valor",orderable:!1,className:"all coluna-valor",render:function(n,t,i){return'<span class="kt-font-'+(i.tipoCategoria=="C"?"success":"danger")+'">'+numeral(n).format("$0,0.00")+"<\/span>"}},{data:null,className:"text-center",orderable:!1,render:function(n,t,i){return i.idParcela!=null?'<i class="fa fa-calendar-alt kt-font-primary kt-padding-l-5 kt-padding-r-5 visualizar-agendamento" style="cursor: pointer;" data-id-agendamento="'+i.idAgendamento+'" data-toggle="kt-popover" data-boundary="window" title="" data-content="Lançamento criado a partir do lançamento de uma parcela." data-original-title="Lançamento de parcela"><\/i>':i.idTransferencia!=null?'<i class="fa fa-share-square kt-font-primary kt-padding-l-5 kt-padding-r-5" style="cursor: help;" data-toggle="kt-popover" data-boundary="window" title="" data-content="Lançamento criado a partir de um transferência entre contas." data-original-title="Transferência"><\/i>':i.pagamentoFatura?'<i class="fa fa-credit-card kt-font-primary kt-padding-l-5 kt-padding-r-5 visualizar-fatura" style="cursor: pointer;" data-id-lancamento="'+i.id+'" data-toggle="kt-popover" data-boundary="window" title="" data-content="Lançamento criado para o pagamento de uma fatura de cartão de crédito." data-original-title="Pagamento de fatura"><\/i>':""}},{data:null,className:"text-center",orderable:!1,render:function(n,t,i){return i.pagamentoFatura?'<button class="btn btn-clean btn-sm btn-icon btn-icon-sm btn-datatables btn-badge" disabled style="cursor:not-allowed;"><i class="la la-list"><\/i><\/button>':'<button data-id="'+i.id+'" class="btn btn-clean btn-sm btn-icon btn-icon-sm btn-datatables btn-badge exibir-detalhes" data-toggle="kt-tooltip" data-boundary="window" data-placement="top" data-original-title="Detalhes"><i class="la la-list"><\/i>'+(i.detalhes>0?'<span class="badge kt-badge kt-badge--dark">'+i.detalhes+"<\/span>":"")+"<\/button>"}},{data:null,className:"text-center",orderable:!1,render:function(n,t,i){return'<button data-id="'+i.id+'" class="btn btn-clean btn-sm btn-icon btn-icon-sm btn-datatables btn-badge exibir-anexos" data-toggle="kt-tooltip" data-boundary="window" data-placement="top" data-original-title="Anexos"><i class="la la-paperclip"><\/i>'+(i.anexos>0?'<span class="badge kt-badge kt-badge--dark">'+i.anexos+"<\/span>":"")+"<\/button>"}},{data:null,className:"text-center",orderable:!1,render:function(n,t,i){return i.idTransferencia!=null||i.pagamentoFatura?'<button class="btn btn-clean btn-sm btn-icon btn-icon-sm btn-datatables" disabled style="cursor:not-allowed;"><span class="la la-edit"><\/span><\/button>':'<button class="btn btn-clean btn-sm btn-icon btn-icon-sm btn-datatables alterar-lancamento" data-id="'+i.id+'" data-toggle="kt-tooltip" data-boundary="window" data-placement="top" data-original-title="Alterar"><span class="la la-edit"><\/span><\/button>'}},{data:null,className:"text-center",orderable:!1,render:function(n,t,i){return'<button class="btn btn-clean btn-sm btn-icon btn-icon-sm btn-datatables excluir-lancamento" data-id="'+i.id+'" data-id-transferencia="'+i.idTransferencia+'" data-pagamento-fatura="'+(i.pagamentoFatura?1:0)+'" data-id-parcela="'+i.idParcela+'" data-toggle="kt-tooltip" data-boundary="window" data-placement="top" data-original-title="Excluir"><span class="la la-trash"><\/span><\/button>'}}],select:{style:"single",info:!1},footerCallback:function(n,t){var f=this.api(),t;let i=0,r=0;t.forEach(function(n){n.tipoCategoria==="C"?i+=n.valor:r+=n.valor});let u=i+r;$(f.column(4).footer()).html('<span class="kt-font-bolder kt-font-'+(u>=0?"success":"danger")+'">'+numeral(u).format("$0,0.00")+"<\/span>")},autoWidth:!1,serverSide:!0,responsive:!1,order:[0,"asc"],searching:!1,paging:!0,pageLength:100,lengthChange:!0}).on("draw.dt",function(){KTApp.initTooltips();KTApp.initPopovers();$("button[class*='exibir-detalhes']").each(function(){let n=$(this).data("id");$(this).click(function(){h(n)})});$("button[class*='exibir-anexos']").each(function(){let n=$(this).data("id");$(this).click(function(){s(n)})});$("button[class*='alterar-lancamento']").each(function(){let n=$(this).data("id"),t={permitirSelecao:!1,callbacks:{salvar:function(){$("#tblLancamento").DataTable().ajax.reload();Bufunfa.obterSaldoAtual($("#iIdConta").val(),"#div-saldo-atual");AppModal.ocultar(!0)}}};$(this).click(function(){Bufunfa.manterLancamento($("#iIdConta").val(),n,t)})});$("button[class*='excluir-lancamento']").each(function(){let t=$(this).data("id"),i=$(this).data("idParcela"),r=$(this).data("id-transferencia"),u=$(this).data("pagamento-fatura")===1,n="";n=i!=null?"<b>Deseja realmente excluir esse lançamento?<\/b><br>Com a exclusão do lançamento a parcela do agendamento será reaberta.":r!=null?"<b>Deseja realmente excluir esse lançamento?<\/b><br>Com a exclusão do lançamento a transferência também será excluída.":u?"<b>Deseja realmente excluir esse lançamento?<\/b><br>Com a exclusão do lançamento o pagamento da fatura será excluído e todas as parcelas associadas a fatura, reabertas.":"Deseja realmente excluir esse lançamento?";$(this).click(function(){AppModal.exibirConfirmacao(n,"Sim","Não",function(){c(t)})})});$("i[class*='visualizar-agendamento']").each(function(){let n=$(this).data("id-agendamento");$(this).click(function(){Bufunfa.manterAgendamento(n)})});$("i[class*='visualizar-fatura']").each(function(){let n=$(this).data("id-lancamento");$(this).click(function(){Bufunfa.exibirFaturaPorLancamento(n)})})})},e=function(){AppModal.exibirPorRota(App.corrigirPathRota("/lancamentos/cadastrar-anexo"),function(){$("#form-manter-anexo").validate({rules:{iLancamentoAnexoDescricao:{required:!0},iLancamentoAnexoNomeArquivo:{required:!0},iLancamentoAnexoConteudoArquivo:{required:!0}},submitHandler:function(){let n=new FormData;n.append("IdLancamento",$("#iIdLancamento").val());n.append("Descricao",$("#iLancamentoAnexoDescricao").val());n.append("NomeArquivo",$("#iLancamentoAnexoNomeArquivo").val());n.append("Arquivo",$("#iLancamentoAnexoConteudoArquivo").get(0).files[0]);$.ajax({url:App.corrigirPathRota("/lancamentos/cadastrar-anexo"),type:"POST",data:n,async:!0,cache:!1,contentType:!1,processData:!1,success:function(n){let i=Feedback.converter(n);i.tipo=="SUCESSO"?(AppModal.ocultar(),t(),$("#tblLancamento").DataTable().ajax.reload()):i.exibir()},error:function(n){let t=Feedback.converter(n.responseJSON);t.exibir()}})}})})},o=function(){AppModal.exibirPorRota(App.corrigirPathRota("/lancamentos/cadastrar-detalhe"),function(){$("#form-manter-detalhe").validate({rules:{sLancamentoDetalheCategoria:{required:!0},iLancamentoDetalheValor:{required:!0}},submitHandler:function(){let n={IdLancamento:$("#iIdLancamento").val(),IdCategoria:$("#sLancamentoDetalheCategoria").val(),Valor:$("#iLancamentoDetalheValor").val(),Observacao:$("#iLancamentoDetalheObservacao").val()};$.post(App.corrigirPathRota("/lancamentos/cadastrar-detalhe"),{entrada:n}).done(function(n){let t=Feedback.converter(n);t.tipo=="SUCESSO"?(AppModal.ocultar(),i(),$("#tblLancamento").DataTable().ajax.reload()):t.exibir()}).fail(function(n){let t=Feedback.converter(n.responseJSON);t.exibir()})}});Bufunfa.criarSelectCategorias({selector:"#sLancamentoDetalheCategoria",dropDownParentSelector:"#portlet-manter-detalhe",obrigatorio:!0});$("#iLancamentoDetalheValor").inputmask("decimal",{radixPoint:",",groupSeparator:".",autoGroup:!0,digits:2,digitsOptional:!1,placeholder:"0",rightAlign:!1,prefix:""})})},s=function(n){AppModal.exibirPorRota(App.corrigirPathRota("/lancamentos/exibir-anexos?idLancamento="+n),function(){$("#btn-cadastrar-anexo").click(function(){e()});$("a[class*='download-anexo']").each(function(){let n=$(this).data("id");$(this).prop("href","/lancamentos/download-anexo?id="+n)});$("button[class*='excluir-anexo']").each(function(){let n=$(this).data("id");$(this).click(function(){AppModal.exibirConfirmacao("Deseja realmente excluir o anexo do lançamento?","Sim","Não",function(){r(n)})})})},!0,"popup-anexo")},h=function(n){AppModal.exibirPorRota(App.corrigirPathRota("/lancamentos/exibir-detalhes?idLancamento="+n),function(){$("#btn-cadastrar-detalhe").click(function(){o()});$("button[class*='excluir-detalhe']").each(function(){let n=$(this).data("id");$(this).click(function(){u(n)})})},!0,"popup-detalhe")},t=function(){$.get(App.corrigirPathRota("lancamentos/listar-anexos?idLancamento="+$("#iIdLancamento").val()),function(n){$("#div-anexos").html(n);$("a[class*='download-anexo']").each(function(){let n=$(this).data("id");$(this).prop("href","/lancamentos/download-anexo?id="+n)});$("button[class*='excluir-anexo']").each(function(){let n=$(this).data("id");$(this).click(function(){AppModal.exibirConfirmacao("Deseja realmente excluir o anexo do lançamento?","Sim","Não",function(){r(n)})})})}).fail(function(n){let t=Feedback.converter(n.responseJSON);t.exibir()})},i=function(){$.get(App.corrigirPathRota("lancamentos/listar-detalhes?idLancamento="+$("#iIdLancamento").val()),function(n){$("#div-detalhes").html(n);$("button[class*='excluir-detalhe']").each(function(){let n=$(this).data("id");$(this).click(function(){u(n)})})}).fail(function(n){let t=Feedback.converter(n.responseJSON);t.exibir()})},c=function(t){$.post(App.corrigirPathRota("/lancamentos/excluir-lancamento?id="+t),function(t){let i=Feedback.converter(t);i.tipo=="SUCESSO"?($("#tblLancamento").DataTable().ajax.reload(),i.exibir(function(){Bufunfa.obterSaldoAtual($("#iIdConta").val(),"#div-saldo-atual");n();AppModal.ocultar()})):i.exibir()}).fail(function(n){let t=Feedback.converter(n.responseJSON);t.exibir()})},r=function(n){$.post(App.corrigirPathRota("/lancamentos/excluir-anexo?id="+n),function(n){let i=Feedback.converter(n);i.tipo=="SUCESSO"?(t(),$("#tblLancamento").DataTable().ajax.reload()):i.exibir()}).fail(function(n){let t=Feedback.converter(n.responseJSON);t.exibir()})},u=function(n){$.post(App.corrigirPathRota("/lancamentos/excluir-detalhe?id="+n),function(n){let t=Feedback.converter(n);t.tipo=="SUCESSO"?(i(),$("#tblLancamento").DataTable().ajax.reload()):t.exibir()}).fail(function(n){let t=Feedback.converter(n.responseJSON);t.exibir()})},n=function(){$.get(App.corrigirPathRota("agendamentos/listar-parcelas-por-conta"),{dataInicio:$("#iProcurarDataInicio").val(),dataFim:$("#iProcurarDataFim").val(),idConta:$("#iIdConta").val()},function(n){$("#div-parcelas-abertas-por-conta").html(n);$("a[class*='visualizar-agendamento']").each(function(){let n=$(this).data("id-agendamento");$(this).click(function(t){t.preventDefault();Bufunfa.manterAgendamento(n)})})}).fail(function(n){let t=Feedback.converter(n.responseJSON);t.exibir()})};return{init:function(){n();$("#btn-cadastrar-lancamento").click(function(){let t={permitirSelecao:!1,callbacks:{salvar:function(){$("#tblLancamento").DataTable().ajax.reload();Bufunfa.obterSaldoAtual($("#iIdConta").val(),"#div-saldo-atual");n();AppModal.ocultar(!0)}}};Bufunfa.manterLancamento($("#iIdConta").val(),null,t)});f();App.aplicarTabelaSelecionavel("#tblLancamento");Bufunfa.aplicarEfeitoContagem("span-saldo-atual",$("#span-saldo-atual").data("valor"));$.validator.addMethod("periodo_valido",function(){let n=moment($("#iProcurarDataInicio").val(),"DD/MM/YYYY").toDate(),t=moment($("#iProcurarDataFim").val(),"DD/MM/YYYY").toDate();return n<=t},"Período inválido.");$("#form-procurar-lancamento").validate({rules:{iProcurarDataInicio:{required:!0,periodo_valido:!0},iProcurarDataFim:{required:!0,periodo_valido:!0}},submitHandler:function(){$("#tblLancamento").DataTable().ajax.reload();Bufunfa.obterSaldoAtual($("#iIdConta").val(),"#div-saldo-atual");n()}});$(".datepicker").datepicker({autoclose:!0,language:"pt-BR",todayBtn:"linked",todayHighlight:!0});$(".datepicker").inputmask({alias:"datetime",inputFormat:"dd/mm/yyyy",placeholder:"dd/mm/aaaa",clearIncomplete:!0});Bufunfa.criarSelectPeriodo({selector:"#sProcurarPeriodo",dropDownParentSelector:"#mProcurar",obrigatorio:!1,callbacks:{selecionar:function(){if($("#sProcurarPeriodo").select2("data").length){let n,t=null;$("#sProcurarPeriodo").select2("data")[0].dataInicio!=null&&$("#sProcurarPeriodo").select2("data")[0].dataFim!=null?(n=moment($("#sProcurarPeriodo").select2("data")[0].dataInicio,"DD/MM/YYYY"),t=moment($("#sProcurarPeriodo").select2("data")[0].dataFim,"DD/MM/YYYY")):(n=moment($("#sProcurarPeriodo").find(":selected").attr("data-dataInicio"),"DD/MM/YYYY"),t=moment($("#sProcurarPeriodo").find(":selected").attr("data-dataFim"),"DD/MM/YYYY"));$("#iProcurarDataInicio").datepicker("update",n.format("DD-MM-YYYY"));$("#iProcurarDataFim").datepicker("update",t.format("DD-MM-YYYY"));$("#iProcurarDataInicio").attr("disabled",!0);$("#iProcurarDataFim").attr("disabled",!0);$("#iProcurarDataInicio").valid();$("#iProcurarDataFim").valid()}else $("#iProcurarDataInicio").datepicker("clearDates"),$("#iProcurarDataFim").datepicker("clearDates"),$("#iProcurarDataInicio").attr("disabled",!1),$("#iProcurarDataFim").attr("disabled",!1)}}});Bufunfa.criarSelectCategorias({selector:"#sProcurarCategoria",dropDownParentSelector:"#mProcurar",obrigatorio:!1});Bufunfa.criarSelectPessoa({selector:"#sProcurarPessoa",dropDownParentSelector:"#mProcurar",permitirCadastro:!0,obrigatorio:!1})},atualizar:function(){$("#tblLancamento").DataTable().ajax.reload();Bufunfa.obterSaldoAtual($("#iIdConta").val(),"#div-saldo-atual");n()}}}();jQuery(document).ready(function(){Lancamento.init()});